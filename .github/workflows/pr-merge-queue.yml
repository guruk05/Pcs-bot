name: Validate code

on:
  workflow_dispatch:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Set custom /etc/resolv.conf for NetBird
        run: |
          echo "Creating /etc/resolv.conf with NetBird DNS..."

          sudo bash -c 'cat > /etc/resolv.conf <<EOF
          # Generated by NetBird
          # If needed you can restore the original file by copying back /etc/resolv.conf.original.netbird

          options attempts:1 timeout:4 ndots:5
          search netbird.selfhosted default.svc.cluster.local svc.cluster.local cluster.local
          nameserver 100.84.103.215
          nameserver 10.43.0.10
          EOF'

          echo "âœ… /etc/resolv.conf created:"
          cat /etc/resolv.conf

          sudo cat /etc/resolv.conf


          NETBIRD_DNS=$(grep -E '^nameserver 100\.(6[4-9]|[7-9][0-9]|1[01][0-9]|12[0-7])\.' /etc/resolv.conf | awk '{print $2}')

          echo "Netbird DNS: $NETBIRD_DNS"

          echo "Running: docker run --dns=$NETBIRD_DNS ..."

        shell: bash
